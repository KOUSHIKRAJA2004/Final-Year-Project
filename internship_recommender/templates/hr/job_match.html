{% extends "base.html" %}

{% block title %}Match Candidates - HR Portal{% endblock %}

{% block content %}
<div class="with-sidebar">
  <div class="sidebar">
    <h2>HR Portal</h2>
    <nav>
      <ul>
        <li><a href="/hr/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="/hr/candidates"><i class="fas fa-users"></i> Candidates</a></li>
        <li><a href="/hr/jobs"><i class="fas fa-briefcase"></i> Job Postings</a></li>
        <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </nav>
  </div>

  <div class="main-content">
    <div class="top-nav">
      <h1>AI-Powered Candidate Matching</h1>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <a href="/hr/jobs" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>
        <div class="user-avatar">
          {{ (user.full_name or user.username)[0]|upper if user else 'H' }}
        </div>
      </div>
    </div>
    
    <div class="content">
      <!-- Job Info -->
      <div class="card" style="margin-bottom: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h2 style="margin-top: 0; color: white;">{{ job_posting.title }}</h2>
        {% if job_posting.location %}
        <p><i class="fas fa-map-marker-alt"></i> {{ job_posting.location }}</p>
        {% endif %}
        {% if job_posting.required_skills %}
        <div style="margin-top: 1rem;">
          <strong>Required Skills:</strong>
          <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
            {% for skill in job_posting.required_skills.split(',') %}
              <span style="background: rgba(255,255,255,0.3); color: white; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">{{ skill.strip() }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Filter Form -->
      <div class="card" style="margin-bottom: 2rem;">
        <h3>Refine Search</h3>
        <form method="GET" action="/hr/job/{{ job_posting.id }}/match" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <input type="hidden" name="job_id" value="{{ job_posting.id }}">
          <div class="form-group">
            <label>Additional Skills Filter</label>
            <input type="text" name="skills" value="{{ filters.skills or '' }}" placeholder="Python, Java">
          </div>
          <div class="form-group">
            <label>Location</label>
            <input type="text" name="location" value="{{ filters.location or '' }}" placeholder="City, State">
          </div>
          <div class="form-group">
            <label>Degree</label>
            <input type="text" name="degree" value="{{ filters.degree or '' }}" placeholder="B.Tech">
          </div>
          <div class="form-group">
            <label>Stream</label>
            <input type="text" name="stream" value="{{ filters.stream or '' }}" placeholder="CS, IT">
          </div>
          <div class="form-group" style="display: flex; align-items: end; gap: 0.5rem;">
            <button type="submit" class="btn" style="flex: 1;"><i class="fas fa-search"></i> Search</button>
            <a href="/hr/job/{{ job_posting.id }}/match" class="btn btn-secondary">Clear</a>
          </div>
        </form>
      </div>

      <!-- Matched Candidates -->
      <div class="card">
        <h3>Matched Candidates ({{ matched_candidates|length }})</h3>
        <p style="color: #666; margin-bottom: 1.5rem;">Candidates are ranked by AI-powered match score</p>
        
        {% if matched_candidates %}
          <div style="display: grid; gap: 1.5rem; margin-top: 1.5rem;">
            {% for match in matched_candidates %}
            <div style="border: 2px solid {% if match.overall_score >= 85 %}#28a745{% elif match.overall_score >= 70 %}#ffc107{% else %}#dc3545{% endif %}; border-radius: var(--border-radius); padding: 1.5rem; background: var(--accent);">
              <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
                <div style="flex: 1; min-width: 300px;">
                  <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: {% if match.overall_score >= 85 %}#28a745{% elif match.overall_score >= 70 %}#ffc107{% else %}#dc3545{% endif %}; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;">
                      {{ match.overall_score|int }}
                    </div>
                    <div>
                      <h4 style="margin: 0; color: var(--primary); font-size: 1.3rem;">
                        {{ match.candidate_name }}
                      </h4>
                      <p style="margin: 0.25rem 0; color: #666;">
                        <i class="fas fa-envelope"></i> {{ match.candidate_email }}
                      </p>
                      <p style="margin: 0.5rem 0 0 0;">
                        <span style="background: {% if match.overall_score >= 85 %}#28a745{% elif match.overall_score >= 70 %}#ffc107{% else %}#dc3545{% endif %}; color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.9rem; font-weight: 500;">
                          {{ match.recommendation }}
                        </span>
                      </p>
                    </div>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0;">
                    <div>
                      <strong>Skill Match:</strong> {{ match.skill_match_score }}%
                      <div style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 0.25rem;">
                        <div style="background: var(--primary); height: 100%; width: {{ match.skill_match_score }}%; border-radius: 4px;"></div>
                      </div>
                    </div>
                    <div>
                      <strong>Matched Skills:</strong> {{ match.matched_count }}/{{ match.total_required }}
                    </div>
                    <div>
                      <strong>Missing Skills:</strong> {{ match.missing_count }}
                    </div>
                  </div>

                  {% if match.matched_skills %}
                  <div style="margin-top: 1rem;">
                    <strong>Matched Skills:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                      {% for skill in match.matched_skills[:8] %}
                        <span style="background: #28a745; color: white; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">{{ skill }}</span>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}

                  {% if match.missing_skills %}
                  <div style="margin-top: 1rem;">
                    <strong>Missing Skills:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                      {% for skill in match.missing_skills[:8] %}
                        <span style="background: #dc3545; color: white; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">{{ skill }}</span>
                      {% endfor %}
                    </div>
                  </div>
                  {% endif %}
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                  <a href="/hr/job/{{ job_posting.id }}/candidate/{{ match.candidate_id }}" class="btn">
                    <i class="fas fa-chart-line"></i> View Insights
                  </a>
                  <a href="/hr/candidate/{{ match.candidate_id }}" class="btn btn-secondary">
                    <i class="fas fa-user"></i> Full Profile
                  </a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <div style="text-align: center; padding: 3rem; color: #999;">
            <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
            <p>No candidates matched. Try adjusting your filters or check back later.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<style>
  .card {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: 0 2px 10px var(--shadow);
  }
</style>
{% endblock %}

